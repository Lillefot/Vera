String.prototype.insertAt=function(index, string) {
  return this.substr(0, index) + string + this.substr(index);
}

// class lecture {
//   constructor(lectureID, lectureGoodBad)
//     this.ID = lectureID;
//     this.goodBad = lectureGoodBad;
// }

window.onload = function(){
  console.log('Window loaded');
  goodRadioButton = document.getElementById('q1r1');
  badRadioButton = document.getElementById('q1r2');
  goodBadChoice = null;
  databasePHP = 'http://script.studieradet.se/kurskurt/database.php';

// Get userID from cas2.php via iframe login
  window.addEventListener('message',function(e) {
  var key = e.message ? 'message' : 'data';
  var data = e[key];
  window.localStorage.setItem("user", data);
  var user = window.localStorage.getItem("user");
  document.getElementById('user').value = user;
  console.log('User = ' + document.getElementById('user').value);
  },false);
  getCount();

  $(document).on("click", "#resultsTable tbody tr", function() {
        var lectureName = $(this).children('.nameCell').text();
        console.log(lectureName);
    });
}

// Clear eventList
eventList = null;

// Run parseICS.php to get all events and their end times from .ics file
//TODO: Get .ics file from Studentportalen
var parseICS = function(){
  console.log("parseICS");
  var xhr = new XMLHttpRequest();
  var url = "http://script.studieradet.se/kurskurt/parseICS.php";
  xhr.open("POST", url, true);
  xhr.setRequestHeader("Content-type", "application/json; charset=UTF-8");
  xhr.onreadystatechange = function () {
      //Run on success
      if (xhr.readyState === 4 && xhr.status === 200) {
          //Set icsArray of form to the eventList generated by parseICS.php
          eventList = JSON.parse(xhr.responseText);
          console.log("JSON responseText: " + eventList);
          document.getElementById('icsArray').value = eventList;
      }
  };
  xhr.send();
}

// Logs events in eventList
var listAllEvents = function () {
  console.log('icsArray: ' + document.getElementById('icsArray').value);
  for (var i in eventList) {
    console.log(eventList[i].title + " " + eventList[i].endTime);
  }
}

//Submits form to database
function submitForm() {
  console.log('Checking form!')

  //Set variables depending on good/bad choice
  if (goodRadioButton.checked){
    goodBadChoice = goodRadioButton.value;
  }
  else if (badRadioButton.checked) {
    goodBadChoice = badRadioButton.value;
  }

  //Check if user has chosen good/bad and then submits form
  if (goodBadChoice) {
  console.log('Submitting form!');
  console.log('goodBadChoice = ' + goodBadChoice);
  document.getElementById('fKurtForm').action = databasePHP;
  document.getElementById('fKurtForm').submit();
  console.log('Form submitted!');
  }
  //If good/bad not chosen
  else {
    alert('Fyll i om bra eller dålig!');
  }
}

//List results from corresponding course
function getResults() {
  var choice = document.getElementById('courseID').value;
  var xhr = new XMLHttpRequest();
  var url = "http://script.studieradet.se/kurskurt/listResults.php";
  var url = url + "?courseChoice=" + choice;
  xhr.onreadystatechange = function () {
      //Run on success
      if (xhr.readyState === 4 && xhr.status === 200) {
          console.warn(xhr.responseText);
          allResultsArray = JSON.parse(xhr.responseText);
          console.log(allResultsArray);
      }
  };
  xhr.open("GET", url, true);
  xhr.send(null);
}

function haveAnswered() {
  var choice = document.getElementById('courseID').value;
  var user = document.getElementById('user').value;
  var xhr = new XMLHttpRequest();
  var url = "http://script.studieradet.se/kurskurt/haveAnswered.php";
  var url = url + "?courseChoice=" + choice + "&user=" + user;
  xhr.onreadystatechange = function () {
      //Run on success
      if (xhr.readyState === 4 && xhr.status === 200) {
          console.warn(xhr.responseText);
          haveAnsweredArray = JSON.parse(xhr.responseText);
          console.log(haveAnsweredArray);
          markAnswered();
      }
  };
  xhr.open("GET", url, true);
  xhr.send(null);
}

function markAnswered() {
  _.each(haveAnsweredArray, function(entry){
    var rowID = "#rowLectureID" + entry.lectureID;
    if (entry.comment) {
      $(rowID).children('.answeredCell')
        .css('background-color', '#5bff4c')
        .empty()
        .append('Kommenterat');
    }
    else {
      $(rowID).children('.answeredCell')
        .css('background-color', '#fffdaa')
        .empty()
        .append('Fyllt i Bra/Dålig');
    }
  });
}

function getCount() {
  var choice = document.getElementById('courseID').value;
  var xhr = new XMLHttpRequest();
  var url = "http://script.studieradet.se/kurskurt/countEntries.php";
  var url = url + "?courseChoice=" + choice;
  xhr.onreadystatechange = function () {
      //Run on success
      if (xhr.readyState === 4 && xhr.status === 200) {
          console.warn(xhr.responseText);
          allResultsArray = JSON.parse(xhr.responseText);
          console.log(allResultsArray);
          listAllResults();
          haveAnswered();
      }
  };
  xhr.open("GET", url, true);
  xhr.send(null);
}
function listAllResults() {
    var tableRowTags = "<tr class='clickableRow' id='rowLectureID'></tr>";
    var tableCellTags = "<td></td>";
    var tableCellResultTags = "<td class='resultCell'>%</td>";
    var tableCellNameTags = "<td class='nameCell'></td>";
    var tableCellEntriesTags = "<td class='entriesCell'> Svar</td>";
    var tableCellAnsweredTags = "<td class='answeredCell'>Ej Svarat än</td>";
    var colourGradient = new Rainbow();
    colourGradient.setSpectrum('#ffaaaa', '#fffdaa', '#5bff4c');

    $('#resultsTable').empty();
    _.each(allResultsArray,function(entry){
      var cellLectureName = tableCellNameTags.insertAt(21, entry.lectureName);
      var entryTotalInt = Number(entry.total, 10);
      var entryGoodInt = Number(entry.good, 10);
      var resultPercent = Math.round((entryGoodInt / entryTotalInt) * 100);
      var cellEntries = tableCellEntriesTags.insertAt(24, entryTotalInt);
      var cellResult = tableCellResultTags.insertAt(23, resultPercent);
      var rowContents = cellLectureName + cellResult + cellEntries + tableCellAnsweredTags;
      var newRow = tableRowTags.insertAt(43, rowContents);
      newRow = newRow.insertAt(41, entry.lectureID);
      $('#resultsTable').append(newRow);

      if (Number.isNaN(resultPercent)) {
        var hexColour = '#F8F8FF';
      }
      else {
        var hexColour = colourGradient.colourAt(resultPercent);
      }

      // var rgbaCol = 'rgba(' + parseInt(hexColour.slice(-6,-4),16)
      // + ',' + parseInt(hexColour.slice(-4,-2),16)
      // + ',' + parseInt(hexColour.slice(-2),16)
      // +',0.5)';

      var rowID = "#rowLectureID" + entry.lectureID + " td:first-child";
      $(rowID).css('background-color', hexColour);

    });
}
